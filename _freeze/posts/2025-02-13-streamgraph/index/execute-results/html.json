{
  "hash": "3192cc863e5e84ac4aeccb19be9adcd7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Stream graphs are a real scream ðŸ˜±\"\ndescription: \"Looking at horror franchises over time using {ggstream}\"\nauthor:\n  - name: Jess Graves\ndate: 02-17-2025\nexecute-dir: project\ncrossref:\n  fig-title: '**Figure**'\n  tbl-title: '**Table**'\n  fig-labels: arabic\n  tbl-labels: arabic\n  title-delim: \".\"\nlink-citations: true\nexecute:\n  echo: true\n  warning: false\n  message: false\ncategories: [data visualization, kaggle, blogging-to-learn, R] # self-defined categories\nimage: preview-image.png\ndraft: false  \n# bibliography: references.bib\nnocite: |\n  @*\n# csl: statistics-in-biosciences.csl\nbibliographystyle: apa\ncitation: true\n---\n\n\n\n\n## Summary\n\nI recently came across [data-to-viz](https://www.data-to-viz.com/graph/streamgraph.html)'s page on stream graphs and was inspired to learn how to use {[`ggstreams`](https://github.com/davidsjoberg/ggstream)}, [`ggplot_build()`](https://ggplot2.tidyverse.org/reference/ggplot_build.html), {[ggrepel](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html)}, and {[`colorspace`](https://colorspace.r-forge.r-project.org)}.\n\n## What's a stream graph?\n\nFrom [Wiki](https://en.wikipedia.org/wiki/Streamgraph):\n\nStreamgraph\n\n:   A streamgraph, or stream graph, is a type of [stacked area](https://en.wikipedia.org/wiki/Area_chart) graph which is displaced around a [central axis](https://en.wikipedia.org/wiki/Cartesian_coordinate_system), resulting in a flowing, organic shape.\n\nHere is a pretty example that was [made in R](https://r-graph-gallery.com/web-streamchart-with-ggstream.html):\n\n[![A gorgeous stream graph on R Graph Gallery](images/clipboard-2662324905.png){width=\"75%\"}](https://r-graph-gallery.com/web-streamchart-with-ggstream.html)\n\n## Code\n\n### Set up libraries & defaults\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for libraries & custom functions & themes\"}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(ggstream)\nlibrary(colorspace)\nlibrary(patchwork)\nlibrary(ggrepel)\nlibrary(ggpubr)\nlibrary(ggExtra)\n\n# setting ggplot theme\nmy_theme <- theme_classic(base_size = 12) +\n  theme(\n    axis.title = element_text(size = 18),\n    axis.text = element_text(size = 16)\n  )\n\ntheme_set(my_theme)\n```\n:::\n\n\n\n\n### The dataset\n\nThe data comes from a [kaggle](https://www.kaggle.com/datasets/monkeybusiness7/horror-franchise-box-office-revenues) data set on horror movies. I'm going to be focusing on looking at trends across horror franchises over time.\n\nFirst, a tiny bit of data tidying. I'm going to:\n\n1.  Get the dates in the right format,\n2.  Drop `Friday the 13th, Nightmare on Elm Street` as a franchise because it's a cross-over with an n of 1\n3.  Level the Franchises by their earliest date of release\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\ndf <- read_csv(\"horror_movie_boxoffice.csv\") %>%\n  mutate(\n    `Release Date` = as.Date(`Release Date`, format = \"%m/%d/%Y\"),\n    Year = year(`Release Date`)\n  ) %>%\n  filter(Franchise !=\n    \"Friday the 13th, A Nightmare on Elm Street\") %>%\n  mutate(Franchise = factor(gsub(\n    \"The Texas Chainsaw Massacre\", \"TX Chainsaw Massacre\",\n    gsub(\"Street\", \"St.\", Franchise)\n  )))\n\n# Ordering franchises by their earliest release date\norder_of_release <- df %>%\n  dplyr::select(Franchise, `Release Date`) %>%\n  group_by(Franchise) %>%\n  arrange(Franchise, `Release Date`) %>%\n  slice(1) %>%\n  ungroup() %>%\n  arrange(`Release Date`)\n\nlevels_by_release <- order_of_release$Franchise\ndf$Franchise <- factor(df$Franchise, levels = levels_by_release)\n```\n:::\n\n\n\n\nThere are 20 different franchises in this dataset, with Halloween coming in first with the most films in the dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfranchises <- df %>%\n  group_by(Franchise) %>%\n  tally() %>%\n  arrange(desc(n))\n\nfranchises %>%\n  mutate(Franchise = factor(Franchise, levels = franchises$Franchise)) %>%\n  ggplot(aes(x = Franchise, y = n)) +\n  geom_bar(stat = \"identity\") +\n  theme(axis.text.x = element_text(angle = 25, hjust = 1)) +\n  scale_y_continuous(breaks = scales::pretty_breaks(10)) +\n  labs(x = \"\", y = \"# of films in dataset\")\n```\n\n::: {.cell-output-display}\n![Number of films by franchise](index_files/figure-html/fig-bar-franchises-1.png){#fig-bar-franchises width=960}\n:::\n:::\n\n\n\n\n### ggstream()\n\n#### Tomato Meter\n\nBased on the kaggle documentation, the `Tomato Meter = \"The score given by professional critics on Rotten Tomatoes.\"`\n\nI'm going to use `ggstream()` to see what franchises are getting the highest ratings at what point in time.\n\nFor the sake of illustrating how freaking easy it is to use, I'm going to forgo any formatting for now.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nratings0 <- df %>%\n  ggplot(aes(\n    x = `Release Date`,\n    y = `Tomato Meter`,\n    fill = Franchise,\n    color = Franchise,\n    text = Franchise,\n    label = Franchise\n  )) +\n  geom_stream()\n\nratings0\n```\n\n::: {.cell-output-display}\n![Boom! One line! geom_stream, you're so easy!](index_files/figure-html/fig-stream-franchise-nakey-1.png){#fig-stream-franchise-nakey width=1248}\n:::\n:::\n\n\n\n\nAlright, going to try to make it a little more aesthetically pleasing, but using {[colorspace](https://colorspace.r-forge.r-project.org)} to choose my color palette. Because the Franchises are ordered by earliest release date, I'm going to go with a sequential color palette.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for setting palette\"}\nn_franchise <- length(unique(df$Franchise))\n# Palette for streams\npal <- sequential_hcl(n_franchise, \"BluGrn\")\n# Palette for labels\npal2 <- darken(sequential_hcl(n_franchise, \"BluGrn\"), amount = 0.2, space = \"HCL\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for color palette figure\"}\ncolor_data <- tibble(\n  color = factor(seq_along(pal)),\n  value = 1\n)\n\ncolor_data %>%\n  ggplot(aes(x = color, y = value, fill = color)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_manual(values = pal) +\n  theme(\n    legend.position = \"none\",\n    axis.ticks = element_blank(),\n    axis.text = element_blank(),\n    axis.line = element_blank(),\n    plot.title = element_text(hjust = 0.5)\n  ) +\n  labs(x = \"\", y = \"\", title = \"My custom palette\")\n```\n\n::: {.cell-output-display}\n![Checking out what my palette will look like](index_files/figure-html/fig-palette-1.png){#fig-palette width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for setting new theme\"}\nnew_theme <- theme_classic() +\n  theme(\n    plot.background = element_rect(fill = \"grey95\"),\n    panel.background = element_rect(fill = \"grey95\"),\n    legend.background = element_rect(fill = \"grey95\"),\n    legend.text = element_text(size = 12),\n    axis.line = element_line(color = \"grey80\"),\n    axis.ticks = element_line(color = \"grey80\"),\n    axis.text = element_text(color = \"grey50\", size = 14),\n    axis.title = element_text(color = \"grey50\", size = 18),\n    axis.line.y = element_blank(),\n    axis.text.y = element_blank()\n  )\ntheme_set(new_theme)\n```\n:::\n\n\n\n\nTime to apply the formatting.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for plot\"}\nratings <- ratings0 +\n  scale_y_continuous(breaks = scales::pretty_breaks(10)) +\n  scale_x_date(\n    breaks = \"5 year\", date_labels = \"%Y\",\n    expand = c(0, 0)\n  ) +\n  scale_fill_manual(name = \"\", values = pal) +\n  scale_color_manual(name = \"\", values = pal) +\n  theme(\n    legend.position = \"top\",\n    axis.text.y = element_blank(),\n    axis.ticks.y = element_blank()\n  ) +\n  guides(fill = guide_legend(nrow = 3))\n\nratings\n```\n\n::: {.cell-output-display}\n![Tomatometer score for each franchise over time with formatting](index_files/figure-html/fig-stream-franchise-2-1.png){#fig-stream-franchise-2 width=1344}\n:::\n:::\n\n\n\n\nWith 20 different levels, the legend can be a bit difficult to visually map onto the stream colors. So, let's check out `geom_stream_label()`, which is a nice built in function that adds labels.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nratings_labels <- ratings +\n  geom_stream_label(\n    fontface = \"bold\",\n    hjust = 0.25,\n    vjust = -0.5,\n    size = 5,\n    color = pal2\n  ) +\n  theme(legend.position = \"none\")\n\nratings_labels\n```\n\n::: {.cell-output-display}\n![Tomatometer score for each franchise over time with labels](index_files/figure-html/fig-stream-franchise-labels-1.png){#fig-stream-franchise-labels width=1248}\n:::\n:::\n\n\n\n\nNot too bad â€“ but I found it a bit hard to get the labels where I wanted with this many levels. And I'm not totally sure why the labels are being put where they are.\n\nTo try to get a little bit more customization in the labeling, I'm going to use `ggplot_build()` to get the data that's generated from the `geom_stream_label()` call and then modify it. (The reasons I'm calling it after `geom_stream_label()` is because the transformation into stream-space is done within the `geom_stream_label()`.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code to get label data for plot\"}\n# Earliest release data\nearliest_release <- order_of_release %>%\n  ungroup() %>%\n  rename(label = Franchise)\n\n# Get the label data\nratings_data <- ggplot_build(ratings_labels)$data[[1]] %>%\n  as_tibble() %>%\n  rename(x0 = x)\n\n# Transforming the stream-data back to date data\nmin_x <- min(ratings_data$x0)\ntarget_date <- min(df$`Release Date`)\norigin_date <- target_date - min_x\nratings_data$x <- as.Date(ratings_data$x0, origin = origin_date)\n\n# Combining the rating data with the earliest release data\nrd <- ratings_data %>%\n  left_join(., earliest_release) %>%\n  mutate(dist_release = abs(x - `Release Date`))\n\n# The dates don't line up perfectly, so finding the x values in the label dataset are closest to the initial release date \nrd <- rd %>%\n  group_by(label) %>%\n  filter(dist_release == min(dist_release)) %>%\n  # Finding the middle of each stream\n  mutate(midpoint = median(y)) %>% \n  dplyr::select(label, x, midpoint) %>%\n  unique()\n```\n:::\n\n::: {.cell fig-caption='Tomato meter over time with geom_label_repel()'}\n\n```{.r .cell-code  code-summary=\"Code to get label data to add to plot\"}\nratings_repels <- ratings +\n  geom_label_repel(rd,\n    mapping = aes(\n      x = x,\n      y = midpoint,\n      color = label,\n      label = label,\n      fill = label\n    ),\n    inherit.aes = F,\n    segment.color = NA,\n    box.padding = 0.35, # Adjust the padding inside the box\n    point.padding = 0.5, # Space between the label and the point\n    min.segment.length = 0,\n    size = 5,\n    max.overlaps = 11,\n    color = \"white\"\n  ) +\n  theme(legend.position = \"none\") +\n  scale_fill_manual(values = pal)\n\nratings_repels\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-streamgragph-repel-labels-1.png){#fig-streamgragph-repel-labels width=1344}\n:::\n:::\n\n\n\n\n#### Number of films in each franchise over time\n\nTomato Meter tells us what Franchise was getting the most ratings when. Let's switch gears to look at which Franchises dominated the horror market in terms of sheer total number of films over time. We'll be able to see where Franchises have rapid expansion or stay stable over time.\n\nI'm going to pick a different palette for fun.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code to set base plot to add labels to\"}\n# Palette\npal <- sequential_hcl(n_franchise, \"SunsetDark\")\n\nn_films <- df %>%\n  dplyr::select(Franchise, `Release Date`) %>%\n  group_by(Franchise) %>%\n  arrange(Franchise, `Release Date`) %>%\n  mutate(`N of films` = row_number()) %>%\n  ggplot(aes(\n    x = `Release Date`,\n    y = `N of films`,\n    fill = Franchise,\n    color = Franchise,\n    label = Franchise\n  )) +\n  geom_stream() +\n  scale_y_continuous(breaks = scales::pretty_breaks(10)) +\n  scale_x_date(\n    breaks = \"5 year\", date_labels = \"%Y\",\n    expand = c(0, 0)\n  ) +\n  scale_fill_manual(name = \"\", values = pal) +\n  scale_color_manual(name = \"\", values = pal) +\n  theme(legend.position = \"none\") +\n  guides(fill = guide_legend(nrow = 3))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code to get label data\"}\n# Get the label data\nns_data <- ggplot_build(n_films)$data[[1]] %>%\n  as_tibble() %>%\n  rename(x0 = x)\n\nmin_x <- min(ns_data$x0)\ntarget_date <- min(df$`Release Date`)\norigin_date <- target_date - min_x\nns_data$x <- as.Date(ns_data$x0, origin = origin_date)\n\nnd <- ns_data %>%\n  left_join(., earliest_release) %>%\n  mutate(dist_release = abs(x - `Release Date`))\n\nnd <- nd %>%\n  group_by(label) %>%\n  filter(dist_release == min(dist_release)) %>%\n  mutate(midpoint = median(y)) %>%\n  dplyr::select(label, x, midpoint) %>%\n  unique()\n# \n# \n# nd2 <- nd %>%\n#   mutate(\n#     direction = if_else(midpoint < 0,\n#       min(ns_data$y),\n#       max(ns_data$y)\n#     ),\n#     dist_axis = (direction - midpoint),\n#     label_placement = midpoint + dist_axis / .8,\n#     label_placement = if_else(label_placement < 0,\n#       label_placement, -1 * label_placement\n#     )\n#   )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for plot\"}\nn_films_repels <- n_films +\n  geom_label_repel(nd,\n    mapping = aes(\n      x = x,\n      y = midpoint,\n      color = label,\n      label = label,\n      fill = label\n    ),\n    inherit.aes = F,\n    segment.color = NA,\n    box.padding = 0.35, # Adjust the padding inside the box\n    point.padding = 0.5, # Space between the label and the point\n    min.segment.length = 0,\n    size = 5,\n    max.overlaps = 11,\n    color = \"white\"\n  ) +\n  theme(legend.position = \"none\") +\n  scale_fill_manual(values = pal)\n\nn_films_repels\n\nggsave(\"preview-image.png\", n_films_repels,\n  units = \"cm\", width = 32, height = 18\n)\n```\n\n::: {.cell-output-display}\n![Number of films in each franchise over time with labels](index_files/figure-html/fig-stream-franchise-ns-1.png){#fig-stream-franchise-ns width=1248}\n:::\n:::\n\n\n\n\nLove to see it. We can see how Nightmare on Elm Street emerging on the market in the late 80s, and Paranormal Activity exploding around the 2010s. And then there's Child's Play, consistently releasing films from the late 80s into 2020.\n\n## And, just for fun: do ratings change over time?\n\nI was curious to know if there was a general trend in ratings over time â€“ that is, are reviewers generally becoming more or less favorable to horror movies?\n\nBased on @fig-scatter, looks like no. Looks pretty flat.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for scatter\"}\n# setting ggplot theme\nmy_theme <- theme_classic(base_size = 12) +\n  theme(\n    axis.title = element_text(size = 18),\n    axis.text = element_text(size = 16)\n  )\n\ntheme_set(my_theme)\n\np <- df %>%\n  dplyr::select(`Tomato Meter`, Franchise, `Release Date`) %>%\n  ggplot(aes(x = `Release Date`, y = `Tomato Meter`)) +\n  geom_point() +\n  theme(legend.position = \"none\") +\n  stat_smooth(method = \"lm\") +\n  stat_cor(\n    label.y.npc = \"top\",\n    label.x.npc = \"center\"\n  )\n\nggMarginal(p,\n  type = \"histogram\",\n  xparams = list(binwidth = 365 * 2),\n  yparams = list(binwidth = 5)\n)\n```\n\n::: {.cell-output-display}\n![Scatterplot of ratings over time](index_files/figure-html/fig-scatter-1.png){#fig-scatter width=480}\n:::\n:::\n\n\n\n\nBut once you look within Franchises (@fig-scatter-by-franchise), actually looks like most are showing some trending decrease over time. Specific yikes to Texas Chainsaw Massacre, who has tanked 50 points over it's 38 years. And Paranormal Activity & Hellraiser, who burned hot and fast, with a 50 point decline over 6-8 years (This dataset doesn't have the latest Hellraiser...).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code for scatter with correlations\"}\ndf %>%\n  dplyr::select(`Tomato Meter`, Franchise, `Release Date`) %>%\n  ggplot(aes(\n    x = `Release Date`, y = `Tomato Meter`,\n    color = Franchise, fill = Franchise\n  )) +\n  geom_point() +\n  theme(\n    legend.position = \"none\",\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  ) +\n  stat_smooth(method = \"lm\", se = F) +\n  scale_fill_manual(values = pal) +\n  scale_color_manual(values = pal2) +\n  stat_cor(\n    label.x.npc = \"left\", label.y = 90,\n    size = 5\n  ) +\n  facet_wrap(~Franchise) +\n  scale_x_date(date_labels = \"%Y\", breaks = \"10 year\")\n```\n\n::: {.cell-output-display}\n![Scatterplot of ratings over time for each franchise](index_files/figure-html/fig-scatter-by-franchise-1.png){#fig-scatter-by-franchise width=1152}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}